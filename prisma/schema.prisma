// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Product {
  id          String   @id @default(uuid())
  sku         String   @unique
  referenceCode String? @unique
  imageUrl     String?
  name        String
  description String?
  type        String   // HOSE, FITTING, ASSEMBLY, ACCESSORY
  brand       String?
  base_cost   Float?
  price       Float?
  attributes  String?  // JSON string for flexibility (Pressure, Diameter, Material)
  
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  
  inventory   Inventory[]
  movements   InventoryMovement[]
  productionOrderItems ProductionOrderItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  products  Product[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Warehouse entity for multi-location support
model Warehouse {
  id          String     @id @default(uuid())
  code        String     @unique
  name        String
  description String?
  address     String?
  isActive    Boolean    @default(true)
  
  locations   Location[]
  productionOrders ProductionOrder[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Location entity for bin/rack/zone management
model Location {
  id          String     @id @default(uuid())
  code        String     @unique // e.g., "A-12-04" or "ZONE-A-RACK-12-BIN-04"
  name        String
  zone        String?    // e.g., "A", "B", "Receiving"
  aisle       String?    // e.g., "12"
  rack        String?    // e.g., "04"
  level       String?    // e.g., "01" (shelf level)
  isActive    Boolean    @default(true)
  capacity    Float?     // Max capacity in units or volume
  
  warehouseId String
  warehouse   Warehouse  @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  inventory   Inventory[]
  movements   InventoryMovement[]
  productionOrderItems ProductionOrderItem[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Inventory {
  id        String   @id @default(uuid())
  quantity  Float    @default(0)     // On-hand quantity
  reserved  Float    @default(0)     // Reserved for orders
  available Float    @default(0)     // Available = quantity - reserved
  
  productId  String
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  updatedAt DateTime @updatedAt
  
  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
}

enum InventoryMovementType {
  IN           // Receiving/Entry
  OUT          // Picking/Exit
  TRANSFER     // Internal transfer between locations
  ADJUSTMENT   // Inventory adjustment (cycle count, damage)
}

enum ProductionOrderStatus {
  BORRADOR
  ABIERTA
  EN_PROCESO
  COMPLETADA
  CANCELADA
}

model InventoryMovement {
  id        String                @id @default(uuid())
  type      InventoryMovementType
  quantity  Float
  reference String?                // PO, SO, Transfer Order, etc.
  notes     String?
  referenceFilePath String?
  referenceFileName String?
  referenceFileMime String?
  referenceFileSize Int?
  
  productId  String
  product    Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  locationId String?
  location   Location?             @relation(fields: [locationId], references: [id], onDelete: SetNull)
  
  // For TRANSFER type: track from/to locations
  fromLocationCode String?
  toLocationCode   String?

  createdAt DateTime              @default(now())
  
  @@index([productId])
  @@index([locationId])
  @@index([type])
  @@index([createdAt])
}

model ProductionOrder {
  id           String                @id @default(uuid())
  code         String                @unique
  status       ProductionOrderStatus @default(BORRADOR)
  priority     Int                   @default(3)
  customerName String?
  dueDate      DateTime?
  notes        String?

  warehouseId String
  warehouse   Warehouse             @relation(fields: [warehouseId], references: [id], onDelete: Restrict)

  items ProductionOrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([warehouseId])
  @@index([status])
  @@index([createdAt])
}

model ProductionOrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  locationId String
  quantity  Float

  order    ProductionOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product  Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  location Location        @relation(fields: [locationId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())

  @@unique([orderId, productId, locationId])
  @@index([orderId])
  @@index([productId])
  @@index([locationId])
}
